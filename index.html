<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gemini Voice AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#06060e;--bg2:#0b0b16;--panel:#10101e;--panel2:#16162a;
  --border:rgba(255,255,255,0.06);--border2:rgba(255,255,255,0.11);
  --teal:#00d4aa;--teal-glow:rgba(0,212,170,.2);
  --blue:#4d8fff;--blue-glow:rgba(77,143,255,.2);
  --amber:#ffaa33;--red:#ff5566;
  --text:#e0e0f0;--sub:#8888aa;--muted:#44445a;
  --ff:'Playfair Display',Georgia,serif;
  --mono:'IBM Plex Mono',monospace;
}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--mono);font-size:14px;}

/* noise grain */
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;
  opacity:.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");}

/* ── layout ── */
.shell{display:grid;grid-template-columns:280px 1fr 260px;grid-template-rows:52px 1fr;
  grid-template-areas:"bar bar bar" "left mid right";height:100vh;}

/* ── topbar ── */
.topbar{grid-area:bar;display:flex;align-items:center;justify-content:space-between;
  padding:0 22px;border-bottom:1px solid var(--border);background:var(--bg);z-index:10;position:relative;}
.logo{display:flex;align-items:center;gap:9px;font-family:var(--ff);font-size:1rem;color:#fff;letter-spacing:-.01em;}
.logo-gem{width:7px;height:7px;border-radius:2px;background:var(--teal);
  box-shadow:0 0 8px var(--teal-glow);transform:rotate(45deg);flex-shrink:0;}

/* state chip */
.chip{display:flex;align-items:center;gap:7px;padding:4px 14px;border-radius:100px;
  border:1px solid var(--border2);background:var(--panel);
  font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--sub);
  transition:all .35s;position:absolute;left:50%;transform:translateX(-50%);}
.chip.online  {border-color:rgba(0,212,170,.3);background:rgba(0,212,170,.07);color:var(--teal);}
.chip.listen  {border-color:rgba(77,143,255,.35);background:rgba(77,143,255,.08);color:var(--blue);}
.chip.speak   {border-color:rgba(255,170,51,.35);background:rgba(255,170,51,.08);color:var(--amber);}
.chip.think   {border-color:rgba(180,100,255,.3);background:rgba(180,100,255,.07);color:#c084fc;}
.cdot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0;}
.chip.online .cdot,.chip.listen .cdot{animation:cdotpulse 1.6s ease-in-out infinite;}
@keyframes cdotpulse{0%,100%{opacity:1}50%{opacity:.15}}

/* ── left panel ── */
.left{grid-area:left;display:flex;flex-direction:column;
  border-right:1px solid var(--border);background:var(--bg2);overflow:hidden;}
.ph{padding:14px 16px 10px;font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;
  color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0;}
.cfg{padding:14px 16px;display:flex;flex-direction:column;gap:13px;overflow-y:auto;flex:1;}
.cfg::-webkit-scrollbar{width:3px;}
.cfg::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.fl label{display:block;font-size:.58rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--muted);margin-bottom:6px;}
textarea,select{width:100%;background:var(--panel2);border:1px solid var(--border);
  border-radius:7px;color:var(--text);font-family:var(--mono);font-size:.73rem;
  line-height:1.55;outline:none;transition:border-color .2s;}
textarea:focus,select:focus{border-color:rgba(0,212,170,.4);}
textarea{padding:9px 11px;resize:vertical;min-height:86px;}
.sw{position:relative;}
.sw::after{content:'▾';position:absolute;right:9px;top:50%;transform:translateY(-50%);
  color:var(--muted);pointer-events:none;font-size:.72rem;}
select{padding:9px 26px 9px 9px;appearance:none;cursor:pointer;}
.brow{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.btn{flex:1;padding:9px 0;border-radius:7px;border:none;font-family:var(--mono);
  font-size:.65rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase;
  cursor:pointer;transition:all .2s;}
.btn:disabled{opacity:.28;cursor:not-allowed;}
.bs{background:var(--teal);color:#000;box-shadow:0 2px 12px var(--teal-glow);}
.bs:not(:disabled):hover{background:#00efc0;transform:translateY(-1px);box-shadow:0 3px 18px rgba(0,212,170,.4);}
.bx{background:transparent;color:var(--red);border:1px solid rgba(255,85,102,.22);}
.bx:not(:disabled):hover{background:rgba(255,85,102,.08);border-color:var(--red);}

/* ── center ── */
.mid{grid-area:mid;display:flex;flex-direction:column;background:var(--bg);overflow:hidden;position:relative;}
.mid::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 55% 30% at 50% 0%,rgba(0,212,170,.04) 0%,transparent 70%);}

/* orb section */
.orb-sec{display:flex;flex-direction:column;align-items:center;padding:28px 0 16px;flex-shrink:0;position:relative;z-index:1;}
.orb-wrap{position:relative;width:148px;height:148px;}
.orb-ring{position:absolute;inset:0;border-radius:50%;border:1px solid rgba(0,212,170,.07);}
.orb-ring:nth-child(2){inset:11px;border-color:rgba(0,212,170,.1);animation:ospin 6s linear infinite;}
.orb-ring:nth-child(3){inset:22px;border-color:rgba(0,212,170,.05);animation:ospin 9s linear infinite reverse;}
@keyframes ospin{to{transform:rotate(360deg)}}
.orb-core{position:absolute;inset:20px;border-radius:50%;overflow:hidden;
  background:radial-gradient(circle at 38% 32%,#142220,#08100f 65%,#040a08);
  border:1px solid rgba(0,212,170,.12);display:flex;align-items:center;justify-content:center;
  transition:box-shadow .5s;}
.orb-core.idle    {box-shadow:0 0 18px rgba(0,212,170,.06);}
.orb-core.active  {box-shadow:0 0 36px rgba(0,212,170,.18),0 0 70px rgba(0,212,170,.06);}
.orb-core.listen  {box-shadow:0 0 36px rgba(77,143,255,.22),0 0 70px rgba(77,143,255,.07);}
.orb-core.speak   {box-shadow:0 0 36px rgba(255,170,51,.2),0 0 70px rgba(255,170,51,.06);}
.orb-core.think   {box-shadow:0 0 36px rgba(180,100,255,.2),0 0 70px rgba(180,100,255,.06);}
#orbCv{position:absolute;inset:0;width:100%;height:100%;}
.orb-icon{position:relative;z-index:2;color:rgba(0,212,170,.4);width:28px;height:28px;transition:opacity .4s;}
.orb-core.listen .orb-icon,.orb-core.speak .orb-icon,.orb-core.think .orb-icon{opacity:0;}
.orb-lbl{margin-top:14px;font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--muted);transition:color .4s;}
.orb-lbl.active{color:var(--teal);} .orb-lbl.listen{color:var(--blue);}
.orb-lbl.speak{color:var(--amber);} .orb-lbl.think{color:#c084fc;}

/* transcript */
.tx{flex:1;overflow-y:auto;padding:4px 20px 16px;display:flex;flex-direction:column;gap:10px;position:relative;z-index:1;}
.tx::-webkit-scrollbar{width:4px;}
.tx::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.tx-empty{margin:auto;text-align:center;color:var(--muted);font-size:.7rem;line-height:2;}
.tx-empty em{display:block;font-family:var(--ff);font-size:1rem;font-style:italic;color:var(--sub);opacity:.5;margin-bottom:4px;}

.msg{display:flex;gap:9px;animation:mIn .28s cubic-bezier(.2,.8,.3,1) both;}
@keyframes mIn{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse;}
.av{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:.58rem;font-weight:500;flex-shrink:0;margin-top:3px;letter-spacing:.04em;}
.msg.agent .av{background:rgba(0,212,170,.1);color:var(--teal);border:1px solid rgba(0,212,170,.18);}
.msg.user  .av{background:rgba(77,143,255,.1);color:var(--blue);border:1px solid rgba(77,143,255,.18);}
.bbl{max-width:72%;padding:9px 13px;border-radius:11px;font-size:.76rem;line-height:1.65;direction:ltr;unicode-bidi:plaintext;text-align:left;word-break:break-word;}
.msg.agent .bbl{background:var(--panel);border:1px solid var(--border2);border-top-left-radius:3px;color:var(--text);}
.msg.user  .bbl{background:rgba(77,143,255,.09);border:1px solid rgba(77,143,255,.18);border-top-right-radius:3px;color:#ccd5ff;}
.ts{font-size:.56rem;color:var(--muted);margin-top:3px;display:block;}
.msg.user .ts{text-align:right;}

/* typing dots */
.tdots{display:flex;gap:4px;align-items:center;padding:3px 0;}
.tdots span{width:5px;height:5px;border-radius:50%;background:var(--teal);opacity:.3;
  animation:td 1.1s ease-in-out infinite;}
.tdots span:nth-child(2){animation-delay:.18s;} .tdots span:nth-child(3){animation-delay:.36s;}
@keyframes td{0%,100%{opacity:.2;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}

/* ── right panel ── */
.right{grid-area:right;display:flex;flex-direction:column;
  border-left:1px solid var(--border);background:var(--bg2);overflow:hidden;}
.con-body{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:1px;}
.con-body::-webkit-scrollbar{width:3px;}
.con-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.lg{font-size:.6rem;line-height:1.7;color:var(--muted);word-break:break-all;
  white-space:pre-wrap;border-left:2px solid transparent;padding-left:5px;}
.lg.err{color:#ff7788;border-color:var(--red);}
.lg.warn{color:#ffcc66;border-color:var(--amber);}
.lg.ok{color:#55ddaa;border-color:var(--teal);}
.lg.info{color:var(--sub);}
.lg.sys{color:#88aaff;border-color:var(--blue);}
.con-ft{padding:9px 12px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;flex-shrink:0;}
.bcl{background:none;border:none;cursor:pointer;font-family:var(--mono);font-size:.58rem;
  letter-spacing:.08em;text-transform:uppercase;color:var(--muted);padding:3px 7px;border-radius:4px;transition:all .2s;}
.bcl:hover{color:var(--text);background:rgba(255,255,255,.05);}

/* toast */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(50px);
  background:var(--panel2);border:1px solid var(--border2);border-radius:7px;
  padding:9px 18px;font-size:.7rem;color:var(--text);z-index:2000;opacity:0;
  transition:all .3s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
</style>
</head>
<body>
<div class="shell">

  <!-- topbar -->
  <header class="topbar">
    <div class="logo"><div class="logo-gem"></div>Gemini Voice AI</div>
    <div class="chip" id="chip"><div class="cdot"></div><span id="chipTxt">Offline</span></div>
    <div style="font-size:.58rem;color:var(--muted);letter-spacing:.07em;">LiveKit · Realtime</div>
  </header>

  <!-- left: config -->
  <aside class="left">
    <div class="ph">Configuration</div>
    <div class="cfg">
      <div class="fl"><label>System Prompt</label>
        <textarea id="instructions" rows="5">You are a helpful and friendly AI voice assistant. Listen carefully to what the user says and respond naturally in conversation.</textarea>
      </div>
      <div class="fl"><label>Voice</label>
        <div class="sw"><select id="voice">
          <option value="Puck">Puck — Energetic</option>
          <option value="Charon">Charon — Deep</option>
          <option value="Kore">Kore — Warm</option>
          <option value="Fenrir">Fenrir — Bold</option>
          <option value="Aoede">Aoede — Melodic</option>
        </select></div>
      </div>
      <div class="fl"><label>Model</label>
        <div class="sw"><select id="model">
          <option value="gemini-2.5-flash-native-audio-preview-12-2025">Gemini 2.5 Flash</option>
          <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
        </select></div>
      </div>
    </div>
    <div class="brow">
      <button class="btn bs" id="btnS" onclick="startAgent()">▶ Start</button>
      <button class="btn bx" id="btnX" onclick="stopAgent()" disabled>■ Stop</button>
    </div>
  </aside>

  <!-- center: orb + transcript -->
  <main class="mid">
    <div class="orb-sec">
      <div class="orb-wrap">
        <div class="orb-ring"></div><div class="orb-ring"></div><div class="orb-ring"></div>
        <div class="orb-core idle" id="orbCore">
          <canvas id="orbCv"></canvas>
          <svg class="orb-icon" id="orbIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>
          </svg>
        </div>
      </div>
      <div class="orb-lbl" id="orbLbl">Start the agent to begin</div>
    </div>

    <div class="tx" id="tx">
      <div class="tx-empty" id="txEmpty"><em>No messages yet</em>Start agent · speak · see responses here</div>
    </div>
  </main>

  <!-- right: console -->
  <aside class="right">
    <div class="ph" style="display:flex;align-items:center;justify-content:space-between;padding-right:12px;">
      <span>Console</span>
      <div style="display:flex;align-items:center;gap:5px;">
        <div style="width:5px;height:5px;border-radius:50%;background:var(--muted);transition:background .3s;" id="cDot"></div>
        <span style="font-size:.54rem;color:var(--muted);" id="cStat">idle</span>
      </div>
    </div>
    <div class="con-body" id="conBody">
      <div class="lg sys">Ready. Press Start to launch agent.</div>
    </div>
    <div class="con-ft"><button class="bcl" onclick="clearLogs()">Clear</button></div>
  </aside>
</div>
<div class="toast" id="toast"></div>

<script>
/* ═══════════════════════  STATE  ═══════════════════════ */
const API = 'http://localhost:8000';
let running   = false;
let curState  = 'idle';   // idle | active | listening | speaking | thinking
let logSSE    = null;
let evtSSE    = null;
let typingEl  = null;
let micStream = null, audioCtx = null, analyser = null;
let animId    = null;
let idlePhase = 0;

/* ═══════════════════════  CANVAS  ═══════════════════════ */
const cv  = document.getElementById('orbCv');
const ctx2 = cv.getContext('2d');

function resizeCv(){
  const r = document.getElementById('orbCore').getBoundingClientRect();
  cv.width = r.width; cv.height = r.height;
}
window.addEventListener('resize', resizeCv);
setTimeout(resizeCv, 120);

/* ═══════════════════════  MIC  ═══════════════════════ */
async function startMic(){
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    audioCtx  = new (window.AudioContext||window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser  = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;
    src.connect(analyser);
    addLog('Microphone connected','ok');
  }catch(e){ addLog('Mic access denied — waveform limited','warn'); }
}
function stopMic(){
  if(micStream){micStream.getTracks().forEach(t=>t.stop());micStream=null;}
  if(audioCtx){audioCtx.close();audioCtx=null;analyser=null;}
}

const freqData = new Uint8Array(128);
function getVol(){
  if(!analyser) return 0;
  analyser.getByteFrequencyData(freqData);
  return Math.min(freqData.slice(0,48).reduce((a,b)=>a+b,0)/(48*255),1);
}
function getBands(){
  if(!analyser){analyser&&analyser.getByteFrequencyData(freqData);return freqData;}
  analyser.getByteFrequencyData(freqData);
  return freqData;
}

/* ═══════════════════════  DRAW  ═══════════════════════ */
function drawFrame(){
  const w=cv.width, h=cv.height;
  ctx2.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2;

  if(!running || curState==='idle'){
    idlePhase+=.018;
    const g=ctx2.createRadialGradient(cx,cy,0,cx,cy,Math.min(w,h)*.5);
    const a=.04+.025*Math.sin(idlePhase);
    g.addColorStop(0,`rgba(0,212,170,${a*3})`);g.addColorStop(1,'rgba(0,212,170,0)');
    ctx2.fillStyle=g;ctx2.fillRect(0,0,w,h);
    return;
  }

  if(curState==='active'){
    idlePhase+=.02;
    const g=ctx2.createRadialGradient(cx,cy,0,cx,cy,Math.min(w,h)*.45);
    const a=.08+.04*Math.sin(idlePhase);
    g.addColorStop(0,`rgba(0,212,170,${a*2})`);g.addColorStop(1,'rgba(0,212,170,0)');
    ctx2.fillStyle=g;ctx2.fillRect(0,0,w,h);
    return;
  }

  if(curState==='listening'){
    // Real mic frequency bars radiating from center
    const bands=getBands();
    const num=56, innerR=Math.min(w,h)*.27, maxH=Math.min(w,h)*.23;
    for(let i=0;i<num;i++){
      const angle=(i/num)*Math.PI*2-Math.PI/2;
      const amp=bands[Math.floor((i/num)*48)]/255;
      const bh=3+amp*maxH;
      const x1=cx+Math.cos(angle)*innerR, y1=cy+Math.sin(angle)*innerR;
      const x2=cx+Math.cos(angle)*(innerR+bh), y2=cy+Math.sin(angle)*(innerR+bh);
      ctx2.strokeStyle=`rgba(77,143,255,${.35+amp*.6})`;
      ctx2.lineWidth=2.2;ctx2.lineCap='round';
      ctx2.beginPath();ctx2.moveTo(x1,y1);ctx2.lineTo(x2,y2);ctx2.stroke();
    }
    const vol=getVol();
    const g=ctx2.createRadialGradient(cx,cy,0,cx,cy,innerR);
    g.addColorStop(0,`rgba(77,143,255,${.1+vol*.25})`);g.addColorStop(1,'rgba(77,143,255,0)');
    ctx2.fillStyle=g;ctx2.beginPath();ctx2.arc(cx,cy,innerR,0,Math.PI*2);ctx2.fill();
    return;
  }

  if(curState==='speaking'){
    // Smooth organic wave rings
    idlePhase+=.055;
    for(let wi=0;wi<3;wi++){
      const rr=(Math.min(w,h)*.14)+wi*9;
      const pts=100;
      ctx2.beginPath();
      for(let i=0;i<=pts;i++){
        const a=(i/pts)*Math.PI*2;
        const amp=.065+.035*wi;
        const r2=rr*(1+amp*Math.sin(a*5+idlePhase+wi*1.3));
        const px=cx+Math.cos(a)*r2, py=cy+Math.sin(a)*r2;
        i===0?ctx2.moveTo(px,py):ctx2.lineTo(px,py);
      }
      ctx2.closePath();
      ctx2.strokeStyle=`rgba(255,170,51,${.55-wi*.13})`;
      ctx2.lineWidth=1.6-wi*.3;ctx2.stroke();
    }
    const g=ctx2.createRadialGradient(cx,cy,0,cx,cy,Math.min(w,h)*.38);
    g.addColorStop(0,'rgba(255,170,51,0.1)');g.addColorStop(1,'rgba(255,170,51,0)');
    ctx2.fillStyle=g;ctx2.fillRect(0,0,w,h);
    return;
  }

  if(curState==='thinking'){
    // Spinning dashed ring
    idlePhase+=.04;
    const r=Math.min(w,h)*.28;
    ctx2.save();ctx2.translate(cx,cy);ctx2.rotate(idlePhase);
    ctx2.setLineDash([8,6]);
    ctx2.strokeStyle='rgba(180,100,255,.6)';ctx2.lineWidth=1.5;
    ctx2.beginPath();ctx2.arc(0,0,r,0,Math.PI*2);ctx2.stroke();
    ctx2.setLineDash([]);ctx2.restore();
    const g=ctx2.createRadialGradient(cx,cy,0,cx,cy,r);
    g.addColorStop(0,'rgba(180,100,255,0.1)');g.addColorStop(1,'rgba(180,100,255,0)');
    ctx2.fillStyle=g;ctx2.fillRect(0,0,w,h);
  }
}

function loop(){ drawFrame(); animId=requestAnimationFrame(loop); }
loop();

/* ═══════════════════════  STATE UI  ═══════════════════════ */
const STATE_CFG = {
  idle:      {chip:'',         cls:'idle',   lbl:'Start the agent to begin',  chipTxt:'Offline'},
  active:    {chip:'online',   cls:'active', lbl:'Agent ready — speak now',   chipTxt:'Online'},
  listening: {chip:'listen',   cls:'listen', lbl:'Listening…',                chipTxt:'Listening'},
  speaking:  {chip:'speak',    cls:'speak',  lbl:'Agent speaking',            chipTxt:'Speaking'},
  thinking:  {chip:'think',    cls:'think',  lbl:'Agent thinking…',           chipTxt:'Thinking'},
  stopped:   {chip:'',         cls:'idle',   lbl:'Agent stopped',             chipTxt:'Offline'},
};

function applyState(s){
  curState = s;
  const c  = STATE_CFG[s] || STATE_CFG.idle;
  const chip = document.getElementById('chip');
  chip.className='chip '+(c.chip||'');
  document.getElementById('chipTxt').textContent = c.chipTxt;
  const core = document.getElementById('orbCore');
  core.className = 'orb-core '+(c.cls||'idle');
  const lbl = document.getElementById('orbLbl');
  lbl.className  = 'orb-lbl '+(c.chip||'');
  lbl.textContent= c.lbl;
}

function setRunning(on){
  running=on;
  document.getElementById('btnS').disabled=on;
  document.getElementById('btnX').disabled=!on;
  document.getElementById('cDot').style.background=on?'var(--teal)':'var(--muted)';
  document.getElementById('cStat').textContent=on?'live':'idle';
  if(!on) applyState('idle');
}

/* ═══════════════════════  TRANSCRIPT  ═══════════════════════ */
function nowTime(){ return new Date().toLocaleTimeString('en-GB',{hour12:false,hour:'2-digit',minute:'2-digit'}); }
function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function removeEmpty(){
  const e=document.getElementById('txEmpty');
  if(e) e.remove();
}

function removeTyping(){
  if(typingEl){typingEl.remove();typingEl=null;}
}

function showTyping(){
  removeEmpty();
  if(typingEl) return;
  const tx=document.getElementById('tx');
  typingEl=document.createElement('div');
  typingEl.className='msg agent';
  typingEl.innerHTML=`<div class="av">AI</div><div><div class="bbl"><div class="tdots"><span></span><span></span><span></span></div></div></div>`;
  tx.appendChild(typingEl);
  tx.scrollTop=tx.scrollHeight;
}

function addMessage(role, text){
  removeEmpty();
  removeTyping();
  const tx=document.getElementById('tx');
  const el=document.createElement('div');
  el.className=`msg ${role}`;
  const init=role==='agent'?'AI':'You';
  el.innerHTML=`
    <div class="av">${init}</div>
    <div>
      <div class="bbl" dir="auto">${esc(text)}</div>
      <span class="ts">${nowTime()}</span>
    </div>`;
  tx.appendChild(el);
  tx.scrollTop=tx.scrollHeight;
}

/* ═══════════════════════  CONSOLE  ═══════════════════════ */
function logClass(line){
  const l=line.toLowerCase();
  if(l.includes('error')||l.includes('traceback')||l.includes('exception')) return 'err';
  if(l.includes('warn')) return 'warn';
  if(l.includes('connected')||l.includes('started')||l.includes('ready')||l.includes(' ok')) return 'ok';
  if(l.includes('info')||l.startsWith('20')) return 'info';
  if(l.startsWith('──')||l.startsWith('[agent')||l.includes('transcript_')) return 'sys';
  return 'info';
}

function addLog(msg, cls){
  const b=document.getElementById('conBody');
  const el=document.createElement('div');
  el.className='lg '+(cls||logClass(msg));
  const t=new Date().toLocaleTimeString('en-GB',{hour12:false});
  el.textContent=`${t}  ${msg}`;
  b.appendChild(el);
  b.scrollTop=b.scrollHeight;
  while(b.children.length>250) b.removeChild(b.firstChild);
}
function clearLogs(){ document.getElementById('conBody').innerHTML=''; }

/* ═══════════════════════  SSE  ═══════════════════════ */
function startStreams(){
  // Raw logs
  if(logSSE){ logSSE.close(); logSSE=null; }
  logSSE=new EventSource(`${API}/logs/stream`);
  logSSE.onmessage=e=>{ if(e.data) addLog(e.data); };

  // Structured events (transcript + state)
  if(evtSSE){ evtSSE.close(); evtSSE=null; }
  evtSSE=new EventSource(`${API}/events/stream`);
  evtSSE.onmessage=e=>{
    if(!e.data||e.data.startsWith(':')) return;
    let ev;
    try{ ev=JSON.parse(e.data); }catch{ return; }

    if(ev.type==='transcript'){
      if(ev.role==='user'){
        removeTyping();
        addMessage('user', ev.text);
        applyState('thinking');
        showTyping();
      } else {
        removeTyping();
        addMessage('agent', ev.text);
        applyState('active');
      }
    } else if(ev.type==='state'){
      const s=ev.state;
      if(s==='listening')      { applyState('listening'); removeTyping(); }
      else if(s==='speaking')  { applyState('speaking');  removeTyping(); }
      else if(s==='thinking')  { applyState('thinking');  showTyping(); }
      else if(s==='active')    { applyState('active'); }
      else if(s==='stopped')   { setRunning(false); }
    }
  };
  evtSSE.onerror=()=>{ document.getElementById('cDot').style.background='var(--muted)'; };
}

function stopStreams(){
  if(logSSE){ logSSE.close(); logSSE=null; }
  if(evtSSE){ evtSSE.close(); evtSSE=null; }
}

/* ═══════════════════════  AGENT CONTROLS  ═══════════════════════ */
function toast(msg,ms=3000){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),ms);
}

async function startAgent(){
  const instructions=document.getElementById('instructions').value.trim();
  const voice=document.getElementById('voice').value;
  const model=document.getElementById('model').value;
  addLog(`Launching — voice=${voice}`,'sys');
  await startMic();
  try{
    const res=await fetch(`${API}/start`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({instructions,voice,model}),
    });
    const d=await res.json();
    addLog(d.message, d.status==='running'?'ok':'warn');
    if(d.status==='running'){
      setRunning(true);
      applyState('active');
      startStreams();
      toast('✓ Agent started');
    }
  }catch{
    addLog('Cannot reach server — is server.py running?','err');
    toast('⚠ Server not reachable');
    stopMic();
  }
}

async function stopAgent(){
  try{
    const res=await fetch(`${API}/stop`,{method:'POST'});
    const d=await res.json();
    addLog(d.message,'warn');
    setRunning(false);
    stopStreams();
    stopMic();
    removeTyping();
    toast('Agent stopped');
  }catch{ addLog('Failed to stop agent','err'); }
}

/* ═══════════════════════  VAD — real mic waveform state  ═══════════════════════ */
let vadTimer=null;
setInterval(()=>{
  if(!running||!analyser) return;
  const vol=getVol();
  if(vol>0.06 && curState!=='speaking' && curState!=='thinking'){
    applyState('listening');
    clearTimeout(vadTimer);
    vadTimer=setTimeout(()=>{ if(curState==='listening') applyState('active'); },700);
  }
},80);

/* ═══════════════════════  STATUS POLL  ═══════════════════════ */
async function checkStatus(){
  try{
    const d=await(await fetch(`${API}/status`)).json();
    const on=d.status==='running';
    if(on!==running){ setRunning(on); if(on&&!evtSSE) startStreams(); }
  }catch{}
}
checkStatus();
setInterval(checkStatus,5000);
</script>
</body>
</html>